<% content_for :head do %>
  <%= javascript_include_tag 'http://js.pusherapp.com/1.5/pusher.min.js' %>
  <script type="text/javascript">
    var pusher = new Pusher('<%= Pusher.key %>');
    var channel = pusher.subscribe('<%= "#{@video.permalink}-#{@screen.uuid}" %>');
    var nick = $.cookie('display_name') || 'Captain Mysterious'
    channel.bind('chatroom', function(message) {
      $('#messages').prepend('<div class="message"><p><span>' + nick + ':&nbsp</span>' + message.text + '</p></div>');
    });
    jQuery(function($) {
      var resetNewMessageForm = function() { $("#new_message")[0].reset() };
      $("#new_message").bind("ajax:complete", resetNewMessageForm);
    });
  </script>
  
  <%= javascript_include_tag '/video-js/video.js' %>
  <%= stylesheet_link_tag '/video-js/video-js.css' %>
  <script type="text/javascript"> 
    // Must come after the video.js library
    // Add VideoJS to all video tags on the page when the DOM is ready
    VideoJS.setupAllWhenReady();
  </script>
  
  <script type="text/javascript">
    var count = 0;
    var notes = [];
    function showNote(text) {
      $('#note').text(notes[count]).fadeIn().delay(3000).fadeOut();
      count = (count + 1) % notes.length;
    }
    $(document).ready(function() {
      $.getJSON('<%= auditorium_json_messages_path(@video.permalink) %>', function(data) {
        notes = data;
        setInterval("showNote();", 5000);
      });
    });
  </script>
<% end %>

<div id="video">
  <%= video_js_tag @video %>
</div>

<div id="chatroom">
  <%= form_for Message.new, :url => auditorium_messages_path(@video.permalink, :screen => @screen.uuid), :remote => true do |f| %>
    <%= f.text_field :text %>
    <%= f.submit %>
  <% end %>
  <div id="messages">
    <%= render :partial => 'auditorium/message', :collection => @messages %>
  </div>
</div>

<div id="note"></div>
